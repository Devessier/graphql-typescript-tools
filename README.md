# TypeScript tools for GraphQL

## Tools

- GraphQL Codegen
- React Query
- Zod
- ts-to-zod

## Features

### Generation of types for queries/mutations/subscriptions in the codebase

- GIF
  1. GQL query is written with a template literal, without being wrapped within `graphql` function
  2. The result of `makeGqlRequest` is not strongly typed
  3. We wrap the template literal within `graphql` function, wait for a few seconds, and see that when hovering the result, it's strongly typed
  4. We can access different properties of the result
  5. Change the query to no longer returning the property we accessed
  6. Wait some seconds, and see a TypeScript error telling that the property is not defined
- When a query, a mutation or a subscription changes in the codebase and is defined as a parameter to `graphql` function, types are automatically regenerated

### Validation of responses from server

- GIF
  1. Change the types generated by GraphQL Codegen to say that it returns a new property
  2. Access the property in code without any TS error
  3. Make the request in the browser, and let Zod throw an error
- Ensures that the server really returns what we expect from it, or throw.

### Autocompletion of queries/mutations/subscriptions

- GIF
  1. Press Ctrl+Espace while cursor is inside the definition of a query
  2. Show that we get autocompletion for fields we can get
  3. Show that we get autocompletion for parameters
     - Autocompletion for where clauses generated by Hasura
- Write queries without leaving your text editor
- It even completes complex queries that Hasura understands (with `where` clauses)

## How does it work?

### Generation of types for queries/mutations/subscriptions in the codebase

- Use GraphQL Codegen
  - Use `client` preset
    - It brings several packages:
      - @graphql-codegen/typescript
        - Takes the GraphQL schema and generates TypeScript types for all types, inputs, enums, queries, mutations, etc.
      - @graphql-codegen/typescript-operations
        - Generates types for queries/mutations/subscriptions found in the codebase
      - @graphql-codegen/typed-document-node
        - Generates a `graphql` function that takes a query/mutation/subscription and returns a `TypedDocumentNode`
        - A `TypedDocumentNode` is an AST representation of the query, with enhanced types to statically know what the query returns and which parameters it takes
        - Thanks to that:
          - We allow the request to be made only if correct variables are provided
          - We type the result of the query
        - As we can not send the AST representation to the GraphQL server, we transform it back into a string with `print` function from `graphql` library.
- Use `makeGqlRequest` function to make queries and mutations
  - It uses function overloading to require variables only if they should be provided
  - The return type of the function is the result of the query or the mutation
- Use `useSubscription` hook to make subscriptions
  - It uses function overloading to require variables only if they should be provided
  - When a new value has been forwarded by the server, it invalidates a React Query key
    - Based on recommendations from https://tkdodo.eu/blog/using-web-sockets-with-react-query
    - It will trigger a refetching

### Validation of responses from server

- Run `ts-to-zod` above types generated by GraphQL Codegen
- Generate validators only for queries, mutations and subscriptions results
- In `makeGqlRequest` and `useSubscription`:
  - Get the validator needed for the request made
    - Say we have written a query called `GetArticleById`
    - `ts-to-zod` has generated a validator called `GetArticleByIdQuery`, and exported it from `graphql.zod.ts` file; for a mutation it would be called `GetArticleByIdMutation`
    - For both functions, we receive a `TypedDocumentNode` it's an AST version of the query typed by the developer
    - It contains the name of the operation, that is the name of the query or the mutation
      - Do `document.definitions[0].name.value`: it gives `GetArticleById`
    - We also need the type of the operation, that is `query`, `mutation` or `subscription`
      - Do `document.definitions[0].operation`: it gives `query`
    - Combine information and import the validator from `graphql.zod.ts`
    - After we receive a result we should parse, use the validator on it

### Autocompletion of queries/mutations/subscriptions

- Install GraphQL VSCode extension: https://marketplace.visualstudio.com/items?itemName=GraphQL.vscode-graphql
- The extension needs to know where to find GraphQL schemas to autocomplete queries, and where are the queries it needs to autocomplete
  - Configuration is defined in `/.graphqlrc.yml`
- We generate GraphQL schema by using another GraphQL Codegen plugin: `schema-ast`

## Comparisons

### tRPC
